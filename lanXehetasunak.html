<!DOCTYPE html> 
<html>
<head>

<!-- Include meta tag to ensure proper rendering and touch zooming -->
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Include jQuery Mobile stylesheets -->
<link rel="stylesheet" href="https://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.css">
<link rel="stylesheet" href="http://cdn.jtsage.com/datebox/1.4.5/jqm-datebox-1.4.5.min.css" />
<!-- Include the jQuery library -->
<script src="https://code.jquery.com/jquery-1.11.3.min.js"></script>

<!-- Include the jQuery Mobile library -->
<script src="https://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js"></script>


    <script type="text/javascript" src="http://cdn.jtsage.com/external/jquery.mousewheel.min.js"></script>
    <script type="text/javascript" src="http://dev.jtsage.com/jQM-DateBox/js/doc.js"></script>
    <script type="text/javascript" src="http://cdn.jtsage.com/datebox/1.4.5/jqm-datebox-1.4.5.core.min.js"></script>
    <script type="text/javascript" src="http://cdn.jtsage.com/datebox/1.4.5/jqm-datebox-1.4.5.mode.calbox.min.js"></script>
    <script type="text/javascript" src="http://cdn.jtsage.com/datebox/1.4.5/jqm-datebox-1.4.5.mode.datebox.min.js"></script>
    <script type="text/javascript" src="http://cdn.jtsage.com/datebox/1.4.5/jqm-datebox-1.4.5.mode.flipbox.min.js"></script>
    <script type="text/javascript" src="http://cdn.jtsage.com/datebox/1.4.5/jqm-datebox-1.4.5.mode.slidebox.min.js"></script>
    <script type="text/javascript" src="http://cdn.jtsage.com/datebox/1.4.5/jqm-datebox-1.4.5.mode.customflip.min.js"></script>
    <script type="text/javascript" src="http://cdn.jtsage.com/datebox/i18n/jqm-datebox.lang.utf8.js"></script>
	<script>
user = window.localStorage.getItem('username');
if(user==null || user==undefined){
	alert("Saioa amaitu da. Saiatu berriro.")
	window.location.replace("index.html");
}

$( "#navbar" ).tabs({
  active: 0
});
</script>
<style>
th {
    border-bottom: 1px solid #d6d6d6;
}

tr:nth-child(even) {
    background: #e9e9e9;
}
@media all and (max-width: 44em) {
    .my-breakpoint .ui-block-a,
    .my-breakpoint .ui-block-b,
	.my-breakpoint .ui-block-c,
	.my-breakpoint .ui-block-d{
      width: 50%;
    }
  }
  @media all and (max-width: 44em) {
    .my-breakpointb .ui-block-a,
    .my-breakpointb .ui-block-b{
	  float:none;
      width: 100%;
    }
  }
  @media all and (max-width: 44em) {
    .my-breakpointc > .ui-block-a ,
    .my-breakpointc > .ui-block-b{
	  float:none;
      width: 100%;
    }
  }
  
 ui-btn ui-input-btn ui-corner-all ui-shadow ui-btn-inline ui-mini ui-icon-delete ui-btn-icon-left{
  float:left;
  }
#lanXehetasunak{
  display: none;
}
</style>
</head>
<body> 

<div data-role="page" id="lanXehetasunak">
	<div class="ui-grid-b" data-role="header" >
		<div class="ui-block-a"><a onclick="location.href = 'nireAbisuak.html';" class="ui-btn ui-icon-arrow-l ui-btn-icon-left">Atzera</a></div>
		<div class="ui-block-b"><center><p>Lan Xehetasunak</p></center></div>
		<div class="ui-block-c"><a onclick="location.href = 'amaitu.html';" style="position: absolute;right: 0;" class="ui-btn ui-icon-power ui-btn-icon-left">Saioa itxi</a></div> 
	</div>
	<div data-role="tabs" id="tab1" >
		<div id="navbar" data-role="navbar" >
				<ul>
				  <li><a href="#fragment-1" onclick="tabidgorde(this.id);return false;" id="tab1" class="ui-btn-active">Abisuaren xehetasunak</a></li>
				  <li><a href="#fragment-2" onclick="tabidgorde(this.id);return false;" id="tab2">Abisua Osatu</a></li>
				</ul>
		</div>
		<div id="fragment-1">
			<fieldset class="ui-grid-c my-breakpoint">
				<div class="ui-block-a">
					<div class="ui-bar ui-bar-a">ID</div>
					<div class="ui-body " id="id"></div>
				</div>
				<div class="ui-block-b">
					<div class="ui-bar ui-bar-a">Saila</div>
					<div class="ui-body" id="saila"></div>
				</div>	
				<div class="ui-block-c">
					<div class="ui-bar ui-bar-a">Lehentasuna</div>
					<div class="ui-body" id="lehentasuna"></div>
				</div>	
				<div class="ui-block-d">
					<div id="bidal" class="ui-bar ui-bar-a">Bidaltzailea</div>
					<div class="ui-body" id="bidaltzailea"></div>
				</div>	
			</fieldset>
			<fieldset class="ui-grid-a my-breakpoint">
				<div class="ui-block-a">
					<div class="ui-bar ui-bar-a">Tokia</div>
					<div class="ui-body" id="tokia"></div>
				</div>
				<div class="ui-block-b">
					<div class="ui-bar ui-bar-a">Data</div>
					<div class="ui-body" id="data"></div>
				</div>
			</fieldset>
			<fieldset class="ui-grid-a my-breakpointb">
				<div class="ui-block-a">
					<div class="ui-bar ui-bar-a" >Laburpena</div>
					<div class="ui-body" id="laburpena"></div>
				</div>
				<div class="ui-block-b">
					<div class="ui-bar ui-bar-a" >Deskribapena</div>
					<div class="ui-body" id="deskribapena"></div>
				</div>
			</fieldset>
					<div class="ui-bar ui-bar-a">Argazkia</div>
					<div class="ui-body"><img id="image" alt="Ez dauka argazkirik." width="100%"></img></div>
		</div>
		<div id="fragment-2">
			<form id="abisuaOsatu">
				<fieldset class="ui-grid-a my-breakpointb">
					<div id="egdiv" class="ui-block-a">
						<select id="egoera" name="egoera" required>
								<option value="">Egoera</option>
								
						</select>
					</div>
					<div class="ui-block-b">
					</div>			
				</fieldset>
				<fieldset class="ui-grid-a my-breakpointb">
					<input style="display:none" name="lanid" id="lanid" type="text" />
					<textarea name="azalpena"  id="azalpena"  placeholder="Azalpena..."></textarea>
					<textarea name="materiala"  id="materiala"  placeholder="Erabilitako materiala..."></textarea>
				</fieldset>
				<div id="lanberriak"></div>
				<button id="berria" type="button">Langile berria</button>
			<input type="submit" value="Gorde" name="submit" id="submit" data-theme="b">
			</form>
		</div>
	</div>
</div>
<script>
var server="http://gapalex.esy.es/"
var lanKop=0;
//Langile berriaren formularioa sortu
$('#berria').click(function () {
	var lang=$("<fieldset  id='lan"+lanKop+"'/>")
	var ard=$("<select name='langile[]' id='ard"+lanKop+"'/>")
	var opt=$("<option value=''>Langilea</option>")
	var grida=$("<div class='ui-grid-a my-breakpointc'></div>")
	var gridb=$("<div class='ui-grid-a'></div>")
	var gridc=$("<div class='ui-grid-a'></div>")
	var block1=$("<div class='ui-block-a'></div>")
	var block2=$("<div class='ui-block-b'></div>")
	var block1b=$("<div class='ui-block-a'></div>")
	var block2b=$("<div class='ui-block-b'></div>")
	var block1c=$("<div class='ui-block-a'></div>")
	var block2c=$("<div class='ui-block-b'></div>")
	
	var ezab=$('<input id="ezab'+lanKop+'" onclick="ezabatuLangileOrduak('+lanKop+','+false+');return false;" type="button" style="float:left;" data-mini="true" data-inline="true" data-icon="delete" value="Ezabatu"/>');
	var lanorduID=$("<div name=lanOrdu[] style='float:right;' id='lanOrdu"+lanKop+"' >lan zenb:"+lanKop+"</div>")
	var dividezab=$("<div id='div2"+lanKop+"' ></div>")
	var inid=$("<input type='hidden' value='' name='id[]'/>")
	dividezab.append(ezab)
	dividezab.append(inid)
	dividezab.append(lanorduID)
	dividezab.append(grida)
	$("#lanberriak").append(dividezab)
	
	grida.append(block1)
	grida.append(block2)
	block1.append(gridb)
	block2.append(gridc)
	gridb.append(block1b)
	gridb.append(block2b)
	gridc.append(block1c)
	gridc.append(block2c)
	
	ard.append(opt)
	var datain=$("<input id='data"+lanKop+"' name='data[]' placeholder='Egin klik data sartzeko...' onfocus='calClick("+lanKop+")' data-icon='calendar' type='text'  data-role='datebox' data-options='{\"mode\": \"calbox\", \"useButton\": false, \"overrideDateFormat\": \"%Y/%m/%d\"}'/>")
	var labelh=$("<label for='denborah"+lanKop+"'>Denbora (h):</label>")
	var denborah=$("<input type='range' name='denborah[]' id='denborah"+lanKop+"' min='0' max='50' value='25' data-popup-enabled='true'>")
	var labelmin=$("<label for='denboramin"+lanKop+"'>Denbora (min):</label>")
	var denboramin=$("<input type='range' name='denboramin[]' id='denboramin"+lanKop+"' min='0' max='59' value='30' data-popup-enabled='true'>")
	
	id="#ard"+lanKop;
	$(id).selectmenu();
	id="#date"+lanKop;
	$(id).datebox();
	id="#denborah"+lanKop;
	$(id).slider().slider('refresh');
	id="#denboramin"+lanKop;
	$(id).slider().slider('refresh');
	block1b.append(lang.append(ard))
	block2b.append(datain)
	block1c.append(labelh)
	block1c.append(denborah)
	block2c.append(labelmin)
	block2c.append(denboramin)
	
	lanPopulatu(lanKop, "");
	$('#lanberriak').trigger('create');
	lanKop=lanKop+1;
});
function calClick(zenb) {
	var id="#data"+zenb;
   $(id).datebox('open');
}
function tabidgorde(id){
	window.localStorage.setItem('tabID',id);
}
function lanPopulatu(zenb, user) {
	var id="#ard"+zenb;
   /*ARDURADUNA BETE*/
		ardfitx = server+"PHP/arduradunaLortu.php?jsoncallback=?"
		$.getJSON( ardfitx, { usuario:user})
		.done(function(arderantzuna) {
			console.log("ONDO2")
			$(arderantzuna).each(function (index, o) {
			if(user==o.username)
				var $option = $("<option selected='selected' id='opt"+o.username+""+lanKop+"'/>").attr("value", o.username).text(o.username);
			else	
				var $option = $("<option id='opt"+o.username+""+lanKop+"'/>").attr("value", o.username).text(o.username);
				$(id).append($option);
				$(id).selectmenu("refresh");
			});
		})
		.fail(function(arderantzuna,textStatus, error) {
			var err = textStatus + ', ' + error;
            console.log("arduradunaLortu Request Failed: " + err);
		})
}
//$(document).on('pagebeforeshow',function(){console.log('pagebeforeshow');});
$(document).ready(function(){
//$(document).on('pagebeforeshow', '#nireAbisuak', function(){       
$.mobile.loading('show');
user = window.localStorage.getItem('username');
id = window.localStorage.getItem('lanID');
tabid = window.localStorage.getItem('tabID');
admin = window.localStorage.getItem('admin');
$('#lanid').val(id);
		/*Lanaren xehetasunak*/
		lanfitx = server+"PHP/lanXehetasunak.php?jsoncallback=?"
		$.getJSON( lanfitx, { usuario:user, lanid:id})
		.done(function(lanerantzuna) {
			$(lanerantzuna).each(function (index, l) {
				ard=l.arduraduna
				$('#id').text(l.id);
				$('#saila').text(l.saila);
				$('#lehentasuna').text(l.lehentasuna);
				if(ard!=user) $('#bidaltzailea').text(l.arduraduna);
				else $('#bidaltzailea').text(l.username);
				$('#tokia').text(l.eraikina+l.pisua+"."+l.gela);
				$('#data').text(l.data);
				$('#laburpena').text(l.laburpena);
				$('#deskribapena').text(l.deskribapena);
				if(l.argazkia!=""){
					$('#image').attr('src', "ARGAZKIAK/"+l.argazkia);
				}
			});
			if(admin=="true"){
				var editatu=$('<input onclick="abisuaEditatu();return false;" type="button" value="Abisua Editatu"/>')
				$("#fragment-1").append(editatu)
				editatu.button()
				editatu.button("refresh")
			}
			if(user==null || ard!=user){
				$("#tab2").hide();
				$("#bidal").text("Arduraduna");
				$("#lanXehetasunak").fadeIn(500);
				$.mobile.loading('hide');
			}else{
				//lanaren xehetasunak lortu
				$('#'+tabid).trigger('click');
				lanxehetasunFitx = server+"PHP/lanHasiak.php?jsoncallback=?"
					$.getJSON( lanxehetasunFitx, { usuario:user, lanid:id})
					.done(function(lanxeheterantzuna) {
						$(lanxeheterantzuna).each(function (index, o) {
							$("#azalpena").val(o.azalpena);
							$("#materiala").val(o.materiala);
						});
					})
					.fail(function(lanxeheterantzuna,textStatus, error) {
						var err = textStatus + ', ' + error;
						alert("Request Failed: " + err);
					});
					/*Lanaren egoera*/
				egoerafitx = server+"PHP/egoeraLortu.php?jsoncallback=?"
				$.getJSON( egoerafitx, { usuario:user, lanid:id})
				.done(function(egoeraerantzuna) {
					console.log("KODEA ONDO")
					$(egoeraerantzuna).each(function (index, o) {
						if(o.izena==null || o.izena=='undefined'){//DATU BASEKIN NOLABAIT LOTU...?
							var id="#"+o;
							$(id).attr("selected","selected");
							var selector=$('#egoera');
							$("select").selectmenu("refresh");
						}
						else{
							var $option = $("<option id='"+o.izena+"'/>").attr("value", o.izena).text(o.izena);
							$('#egoera').append($option);
						}
					});
				})
				.fail(function(egoeraerantzuna,textStatus, error) {
					var err = textStatus + ', ' + error;
					console.log("Request Failed: " + err);
				})
				
				
				/*Langile/Orduak lortu*/
				
				lanOrduak = server+"PHP/langileOrduakLortu.php?jsoncallback=?"
				$.getJSON( lanOrduak, { usuario:user, lanid:id})
				.done(function(lanOrduEran) {
					$(lanOrduEran).each(function (index, o) {
							var lang=$("<fieldset  id='lan"+lanKop+"'/>")
							var ard=$("<select name='langile[]' id='ard"+lanKop+"'/>")
							var opt=$("<option value=''>Langilea</option>")
							var grida=$("<div class='ui-grid-a my-breakpointc'></div>")
							var gridb=$("<div class='ui-grid-a'></div>")
							var gridc=$("<div class='ui-grid-a'></div>")
							var block1=$("<div class='ui-block-a'></div>")
							var block2=$("<div class='ui-block-b'></div>")
							var block1b=$("<div class='ui-block-a'></div>")
							var block2b=$("<div class='ui-block-b'></div>")
							var block1c=$("<div class='ui-block-a'></div>")
							var block2c=$("<div class='ui-block-b'></div>")
							var ezab=$('<input id="ezab'+o.id+'" onclick="ezabatuLangileOrduak('+o.id+','+true+');return false;" type="button" style="float:left;" data-mini="true" data-inline="true" data-icon="delete" value="Ezabatu"/>');
							var lanorduID=$("<div name=lanOrdu[] style='float:right;' id='lanOrdu"+o.id+"' >lanID:"+o.id+"</div>")
							var dividezab=$("<div id='div"+o.id+"' class='ui-body ui-body-a ui-corner-all'></div>")
							var inid=$("<input type='hidden' id='id"+o.id+"' value='"+o.id+"' name='id[]'/>")
							dividezab.append(ezab)
							dividezab.append(inid)
							dividezab.append(lanorduID)
							dividezab.append(grida)
							$("#lanberriak").append(dividezab)
							
							grida.append(block1)
							grida.append(block2)
							block1.append(gridb)
							block2.append(gridc)
							gridb.append(block1b)
							gridb.append(block2b)
							gridc.append(block1c)
							gridc.append(block2c)
							ard.append(opt)
							var datain=$("<input id='data"+lanKop+"' name='data[]' value='"+o.lanEguna+"' placeholder='Egin klik data sartzeko...' onfocus='calClick("+lanKop+")' data-icon='calendar' type='text'  data-role='datebox' data-options='{\"mode\": \"calbox\", \"useButton\": false, \"overrideDateFormat\": \"%Y/%m/%d\"}'/>")
							var labelh=$("<label for='denborah"+lanKop+"'>Denbora (h):</label>")
							var denborah=$("<input type='range' name='denborah[]' id='denborah"+lanKop+"' min='0' max='50' value='"+o.denborah+"' data-popup-enabled='true'>")
							var labelmin=$("<label for='denboramin"+lanKop+"'>Denbora (min):</label>")
							var denboramin=$("<input type='range' name='denboramin[]' id='denboramin"+lanKop+"' min='0' max='59' value='"+o.denboramin+"' data-popup-enabled='true'>")

							id="#ard"+lanKop;
							$(id).selectmenu();
							lanPopulatu(lanKop, o.langilea);
							id="#date"+lanKop;
							$(id).datebox().datebox('refresh');
							id="#denborah"+lanKop;
							$(id).slider().slider('refresh');
							id="#denboramin"+lanKop;
							$(id).slider().slider('refresh');
							block1b.append(lang.append(ard))
							block2b.append(datain)
							block1c.append(labelh)
							block1c.append(denborah)
							block2c.append(labelmin)
							block2c.append(denboramin)
							$('#lanberriak').trigger('create');
							lanKop=lanKop+1;
					});
				})
				.fail(function(lanOrduEran,textStatus, error) {
					var err = textStatus + ', ' + error;
					console.log("langileOrduakLortu Request Failed: " + err);
				})
		
			//$("#lanXehetasunak").fadeIn(500)
			$.mobile.loading('hide');				
		}
		})
		.fail(function(koderantzuna,textStatus, error) {
			var err = textStatus + ', ' + error;
            console.log("lanXehetasunak Request Failed: " + err);
		})	
		//$("#lanXehetasunak").fadeIn(500);	
	
});
$(document).ajaxStop(function () {
    $("#lanXehetasunak").fadeIn(500)
	$.mobile.loading('hide');
});
function abisuaEditatu(){
	window.location.replace("abisuaEditatu.html");
}
function ezabatuLangileOrduak(id, db){
	//Datu basean gorde gabekoa ezabatu (oraindik interfazea soilik)
	if(db==false){
		divid="#div2"+id;
		$(divid).remove();
		lanKop=lanKop-1;
	}else{
	//Datu basean gordetako lanordua ezabatu
		if (confirm("Ziur lanordua ezabatu nahi duzula?")==true){
			ezabaFitx = server+"PHP/ezabatuLangileOrdua.php?jsoncallback=?"
				$.getJSON( ezabaFitx, { usuario:user ,id:id})
				.done(function(ezabaerantzuna) {
					console.log(ezabaerantzuna.mezua)
					if(ezabaerantzuna.zuzen == "ok"){
					divid="#div"+id;
						$(divid).remove();
						//location.reload();
					}
				})
				.fail(function(egoerantzuna,textStatus, error) {
					var err = textStatus + ', ' + error;
					console.log("Delete Request Failed: " + err);
				});
		}else return false;
	}
}

$("form").submit(function(){
event.preventDefault();
var egoera=$("#egoera").val()
//if(egoera=="itxia"){
	//if (confirm("Ziur lana itxi nahi duzula?")==true){
		$.mobile.loading('show');
		var user = window.localStorage.getItem('username');
		var lanid = window.localStorage.getItem('lanID');
		var azalpena=$("#azalpena").val()
		var materiala=$("#materiala").val()
		var egoera=$("#egoera").val()
		xehetasunFitx1 = server+"PHP/lanaOsatu.php?jsoncallback=?"
			$.getJSON( xehetasunFitx1, { usuario:user, lanid:lanid, azalpena:azalpena, materiala:materiala})
			.done(function(xeheterantzuna1) {
				egoeraFitx = server+"PHP/egoeraEguneratu.php?jsoncallback=?"
				$.getJSON( egoeraFitx, { usuario:user, lanid:lanid, egoera:egoera})
				.done(function(egoerantzuna) {
						if(lanKop>0){
							$.post( server+"PHP/langileOrduakGorde.php", $("#abisuaOsatu").serialize())
							.done(function(data){
								$.mobile.loading('hide');
								location.reload(true);
							})
							.fail(function(data){
							})
						}
						location.reload();
				})
				.fail(function(egoerantzuna,textStatus, error) {
					var err = textStatus + ', ' + error;
					console.log("1Request Failed: " + err);
				})
			})
			.fail(function(d, textStatus, error) {
				console.error("getJSON failed, status: " + textStatus + ", error: "+error+ JSON.stringify(d))
			})
	/*}else{
	return false;
	}*/
/*}else{
	$.mobile.loading('show');
		var user = window.localStorage.getItem('username');
		var lanid = window.localStorage.getItem('lanID');
		var azalpena=$("#azalpena").val()
		var materiala=$("#materiala").val()
		var egoera=$("#egoera").val()
		xehetasunFitx2 = "PHP/lanaOsatu.php?jsoncallback=?"
			$.getJSON( xehetasunFitx2, { usuario:user, lanid:lanid, azalpena:azalpena, materiala:materiala})
			.done(function(xeheterantzuna2) {
				egoeraFitx = "PHP/egoeraEguneratu.php?jsoncallback=?"
				$.getJSON( egoeraFitx, { usuario:user, lanid:lanid, egoera:egoera})
				.done(function(egoerantzuna) {
						if(lanKop>0){
							$.post( "PHP/langileOrduakGorde.php", $("#abisuaOsatu").serialize())
							.done(function(data){
								location.reload();
								$.mobile.loading('hide');
							})
							.fail(function(data){
							})
						}
						location.reload();
				})
				.fail(function(egoerantzuna,textStatus, error) {
					var err = textStatus + ', ' + error;
					console.log("1Request Failed: " + err);
				})
			})
			.fail(function(d, textStatus, error) {
				console.error("getJSON failed, status: " + textStatus + ", error: "+error+ JSON.stringify(d))
			})
}*/
});

</script>

</body>
</html>